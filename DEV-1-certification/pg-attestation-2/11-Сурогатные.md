# **Суррогатные ключи в хранилищах данных (DWH): полное объяснение**  

## **1. Что такое суррогатный ключ?**  
**Суррогатный ключ (Surrogate Key)** — это искусственно созданный уникальный идентификатор (обычно `INT` или `BIGINT`), который **не имеет бизнес-смысла** и используется исключительно для связи таблиц в базе данных.  

### **Примеры суррогатных ключей:**  
- `customer_key` (вместо `customer_id` из источника)  
- `product_key` (вместо `product_code`)  
- `order_key` (вместо `order_number`)  

---

## **2. Зачем нужны суррогатные ключи в DWH?**  

### **Основные причины:**  
1. **Избегание зависимости от бизнес-ключей**  
   - Бизнес-ключи (например, `passport_number`) могут меняться, дублироваться или быть `NULL`.  
   - Суррогатные ключи **всегда уникальны** и неизменны.  

2. **Интеграция данных из разных источников**  
   - В DWH данные могут приходить из нескольких систем (`CRM`, `ERP`, `1C`), где один и тот же клиент имеет **разные ID**.  
   - Суррогатный ключ **объединяет** эти записи.  

3. **Поддержка Slowly Changing Dimensions (SCD)**  
   - При изменении атрибутов (например, адреса клиента) создается **новая версия записи** с тем же `business_id`, но новым `surrogate_key`.  

4. **Улучшение производительности**  
   - Целочисленные ключи (`INT`) работают быстрее, чем строковые (`VARCHAR`).  
   - Уменьшают размер индексов.  

---

## **3. Преимущества суррогатных ключей**  

| **Преимущество**             | **Пример** |  
|-----------------------------|------------|  
| **Гарантированная уникальность** | Даже если `customer_id` повторяется в разных источниках, `customer_key` всегда уникален. |  
| **Независимость от бизнес-логики** | Если `product_code` изменится, `product_key` останется прежним. |  
| **Эффективные JOIN-операции** | Сравнение `INT` быстрее, чем `VARCHAR(50)`. |  
| **Поддержка истории изменений (SCD Type 2)** | Позволяет хранить несколько версий одного `customer_id`. |  
| **Упрощение ETL-процессов** | Не нужно проверять сложные бизнес-ключи на дубли. |  

---

## **4. Как реализуются суррогатные ключи?**  

### **Вариант 1: Автоинкремент (`SERIAL` / `IDENTITY`)**  
```sql
CREATE TABLE dim_customer (
    customer_key SERIAL PRIMARY KEY,  -- PostgreSQL
    customer_id VARCHAR(50),          -- Бизнес-ключ из источника
    customer_name TEXT,
    valid_from DATE,
    valid_to DATE
);
```

### **Вариант 2: UUID (если нужна глобальная уникальность)**  
```sql
CREATE TABLE dim_product (
    product_key UUID DEFAULT gen_random_uuid() PRIMARY KEY,  -- Уникальный ключ
    product_id VARCHAR(20),
    product_name TEXT
);
```

### **Вариант 3: Хэш-функция (для детерминированных ключей)**  
```sql
-- Если нужно генерировать ключ на основе бизнес-полей
INSERT INTO dim_employee 
VALUES (md5(employee_id || hire_date)::UUID, employee_id, ...);
```

---

## **5. Пример использования в DWH**  

### **Без суррогатного ключа (проблемы):**  
```sql
-- Проблема: customer_id может дублироваться или меняться
SELECT f.sales, c.*
FROM fact_sales f
JOIN dim_customer c ON f.customer_id = c.customer_id;  -- Риск коллизий!
```

### **С суррогатным ключом (правильно):**  
```sql
-- Надежная связь через customer_key
SELECT f.sales, c.*
FROM fact_sales f
JOIN dim_customer c ON f.customer_key = c.customer_key;  -- Однозначное соответствие
```

---

## **6. Когда НЕ нужны суррогатные ключи?**  
- **Маленькие справочники** (например, `dim_country`).  
- **Одноразовые загрузки** (данные не интегрируются с другими системами).  
- **Где бизнес-ключ идеален** (например, `ISO country codes`).  

---

## **7. Вывод**  
- **Суррогатные ключи** — обязательный элемент профессионального DWH.  
- **Решают проблемы** интеграции, истории изменений и производительности.  
- **Лучшие практики:**  
  - Используйте `INT`/`BIGINT` для производительности.  
  - Всегда делайте `PRIMARY KEY` по суррогатному ключу.  
  - Бизнес-ключи (`customer_id`) храните отдельно как атрибуты.  

**Итог:** Если строите хранилище данных — суррогатные ключи ваши лучшие друзья!




Отличный вопрос про **суррогатные ключи** (surrogate keys) — один из важных аспектов проектирования хранилищ данных и систем с измерениями (dimensions).

---

## Что такое суррогатный ключ?

* **Суррогатный ключ (Surrogate Key)** — это искусственный уникальный идентификатор записи, обычно числовой (целочисленный, автоинкрементный), который не несёт бизнес-смысл.
* Он создаётся и поддерживается в базе данных специально для удобства и однозначной идентификации записей.

---

## Откуда берутся суррогатные ключи?

* Обычно это поле типа `SERIAL` / `BIGSERIAL` в PostgreSQL или автоинкремент в других СУБД.
* Они **генерируются системой** при вставке новой записи (например, `dimension_id`).
* Суррогатный ключ не зависит от данных в записи — это просто уникальный номер.

---

## Как связаны суррогатные ключи и натуральные (бизнес) ключи?

* **Натуральный ключ (Natural Key)** — это набор атрибутов из бизнес-данных, которые уникально идентифицируют запись (например, `ProductCode`, `SKU`, `CustomerEmail`).
* Связь **один к одному** между суррогатным ключом и натуральным ключом в таблице измерений:

| surrogate\_key | natural\_key\_1 | natural\_key\_2 | ... |
| -------------- | --------------- | --------------- | --- |
| 101            | "PROD001"       | "Red"           | ... |

---

## Почему вводят суррогатные ключи?

* Натуральные ключи могут быть **сложными**, длинными или изменяемыми.
* Суррогатный ключ — простой, короткий, неизменяемый идентификатор.
* Позволяет легко создавать связи между таблицами (например, `Fact` таблица ссылается на измерения через суррогатные ключи).

---

## Тип связи между суррогатным и натуральным ключом

* **Тип связи: один к одному (1:1)** внутри таблицы измерений.
* Натуральный ключ однозначно сопоставлен одному суррогатному ключу.

---

## Пример

**Таблица измерения товаров (`DimProduct`):**

| product\_sk (surrogate key) | product\_code (natural key) | product\_name    |
| --------------------------- | --------------------------- | ---------------- |
| 1                           | PROD001                     | Красная футболка |
| 2                           | PROD002                     | Синие джинсы     |

* В таблице фактов будет ссылка на `product_sk` (число), а не на длинный код.

---

## Итог

| Пункт            | Описание                                                             |
| ---------------- | -------------------------------------------------------------------- |
| Суррогатный ключ | Искусственный уникальный ID, автоинкремент                           |
| Натуральный ключ | Бизнес-идентификатор записи (напр. SKU)                              |
| Связь            | 1:1, каждый натуральный ключ соответствует ровно одному суррогатному |
| Зачем            | Упрощение, стабильность, производительность                          |

---

Если хочешь, могу помочь составить пример DDL для суррогатного ключа в таблице измерения.


