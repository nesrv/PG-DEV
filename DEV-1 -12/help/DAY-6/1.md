# –ü—Ä–∞–∫—Ç–∏–∫–∞

## –§—É–Ω–∫—Ü–∏–∏ SQL

## –ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞

```
–í —Ç–∞–±–ª–∏—Ü–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–æ–º–µ—Ä–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π, –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –∫–æ–µ-–∫–∞–∫: –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –∫–∞–∫ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ, —Ç–∞–∫ –∏ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –≤ –ª—é–±–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ.
–ú–µ–∂–¥—É –±—É–∫–≤–∞–º–∏ –∏ —Ü–∏—Ñ—Ä–∞–º–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–µ–ª—ã.
```

## üîß –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

```sql
CREATE TABLE cars(
    id integer PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    regnum text
);

INSERT INTO cars(regnum) VALUES
    ('–ö 123 –•–ú'), ('k123xm'), ('A 098BC');
```


## ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 1: –°—á–∏—Ç–∞—è, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ ¬´–±—É–∫–≤–∞ —Ç—Ä–∏-—Ü–∏—Ñ—Ä—ã –¥–≤–µ-–±—É–∫–≤—ã¬ª, –Ω–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é (3 —Å–ø–æ—Å–æ–±–∞), –≤—ã–¥–∞—é—â—É—é —á–∏—Å–ª–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤.

–ù–∞–ø—Ä–∏–º–µ—Ä, ¬´–ö 123 –•–ú¬ª –∏ ¬´k123xm¬ª —Å—á–∏—Ç–∞—é—Ç—Å—è —Ä–∞–≤–Ω—ã–º–∏.

```sql
CREATE or REPLACE FUNCTION to_normal(regnum text) RETURNS text
AS $$
    SELECT translate(upper(regnum), '–ê–í–ï–ö–ú–ù–û–†–°–¢–£–• ', 'ABEKMHOPCTYX');
$$ LANGUAGE sql;



CREATE or REPLACE FUNCTION  to_normal_2(regnum text) RETURNS text
LANGUAGE sql 
RETURN upper(translate(regnum, '–ê–í–ï–ö–ú–ù–û–†–°–¢–£–• ', 'ABEKMHOPCTYX'));


CREATE OR REPLACE FUNCTION to_normal_3(regnum text) RETURNS text
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN translate(upper(regnum), '–ê–í–ï–ö–ú–ù–û–†–°–¢–£–• ', 'ABEKMHOPCTYX');
END;
$$;


CREATE OR REPLACE FUNCTION to_normal_4(regnum text) RETURNS text
LANGUAGE sql
ATOMIC
AS $$
    SELECT translate(upper(regnum), '–ê–í–ï–ö–ú–ù–û–†–°–¢–£–• ', 'ABEKMHOPCTYX');
$$;

--ATOMIC ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.


--–ø—Ä–æ–≤–µ—Ä–∫–∞
SELECT to_normal('–∫ 123 —Ö–º'), to_normal_1('–∫12 3—Ö–º'), to_normal_2('–∫12 3—Ö–º');

```

---

## ‚úÖ **–ó–∞–¥–∞–Ω–∏–µ 2: –ù–∞–π—Ç–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–æ–º–µ—Ä–æ–≤ —Å —É—á—ë—Ç–æ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏**

**–¶–µ–ª—å:** –í—ã–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç.

### üí° –†–µ—à–µ–Ω–∏–µ:

```sql

--1
SELECT count(DISTINCT to_normal(regnum)) FROM cars;

--2
SELECT to_normal(regnum) AS norm, COUNT(*)
FROM cars
GROUP BY norm
HAVING COUNT(*) > 1;


CREATE FUNCTION num_unique() RETURNS bigint
LANGUAGE sql STABLE
RETURN (
SELECT count(DISTINCT to_normal(regnum))
FROM cars
);


CREATE FUNCTION num_unique_1() RETURNS bigint
LANGUAGE sql STABLE
RETURN (
SELECT COUNT(*)
FROM cars
GROUP BY to_normal(regnum)
HAVING COUNT(*) > 1);


CREATE FUNCTION num_unique_2() RETURNS bigint
LANGUAGE sql STABLE
AS $$
SELECT count(DISTINCT to_normal(regnum))
FROM cars;
$$;

CREATE OR REPLACE FUNCTION num_unique_3() RETURNS bigint
LANGUAGE plpgsql
AS $$
DECLARE
    result bigint;
BEGIN
    SELECT COUNT(DISTINCT to_normal(regnum)) INTO result
    FROM cars;
    RETURN result;
END;
$$;


SELECT num_unique(), num_unique_1(), num_unique_2(), num_unique_3();

```


## –ï—Å–ª–∏ v—ã —Ö–æ—Ç–∏–º –≤–µ—Ä–Ω—É—Ç—å —Ç–∞–±–ª–∏—Ü—É norm + count, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RETURNS TABLE(...):

```sql
CREATE OR REPLACE FUNCTION num_unique_4()
RETURNS TABLE(norm text, count bigint)
LANGUAGE sql STABLE
AS $$
    SELECT to_normal_2(regnum), COUNT(*)
    FROM cars
    GROUP BY to_normal_2(regnum)
$$;

```
## ‚úÖ **–ó–∞–¥–∞–Ω–∏–µ 3: –î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–æ–º–µ—Ä—É**

**–¶–µ–ª—å:** –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—Å—Ç–∞–≤–∫—É –Ω–æ–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —É–∂–µ –µ—Å—Ç—å.

### üí° –†–µ—à–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å):

```sql
CREATE UNIQUE INDEX unique_normalized_regnum ON cars((to_normal(regnum)));
```

> –¢–µ–ø–µ—Ä—å `INSERT INTO cars(regnum) VALUES ('–ö123–•–ú');` ‚Äî –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É, —Ç–∞–∫ –∫–∞–∫ —É–∂–µ –µ—Å—Ç—å —Ç–∞–∫–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä.

---

## ‚úÖ **–ó–∞–¥–∞–Ω–∏–µ 4: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É —Å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä**

**–¶–µ–ª—å:** –•—Ä–∞–Ω–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –µ—ë.

### üí° –†–µ—à–µ–Ω–∏–µ:

```sql
ALTER TABLE cars ADD COLUMN regnum_norm text;

CREATE FUNCTION update_norm() RETURNS trigger AS $$
BEGIN
    NEW.regnum_norm := to_normal(NEW.regnum);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER cars_norm_trigger
BEFORE INSERT OR UPDATE ON cars
FOR EACH ROW
EXECUTE FUNCTION update_norm();
```

–¢–µ–ø–µ—Ä—å:

```sql
INSERT INTO cars(regnum) VALUES ('–Ω456–æ—Å');
SELECT * FROM cars;
```

> –ü–æ–∫–∞–∂–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –≤ –∫–æ–ª–æ–Ω–∫–µ `regnum_norm`.

---

## ‚úÖ **–ó–∞–¥–∞–Ω–∏–µ 5: –ù–∞–π—Ç–∏ –≤—Å–µ –Ω–æ–º–µ—Ä–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã**

**–¶–µ–ª—å:** –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä–∞, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —è–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã, –¥–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏.

### üí° –†–µ—à–µ–Ω–∏–µ:

```sql
SELECT *
FROM cars
WHERE regnum ~ '[–ê-–Ø–∞-—è]';
```

> –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∏—Ç—å –Ω–æ–º–µ—Ä–∞, –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.



## ‚úÖ **–ó–∞–¥–∞–Ω–∏–µ 6: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å –∏–Ω–¥–µ–∫—Å–æ–º –∏ –±–µ–∑**

**–¶–µ–ª—å:** –°—Ä–∞–≤–Ω–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `normalize()` —Å –∏–Ω–¥–µ–∫—Å–æ–º –∏ –±–µ–∑.

### üí° –†–µ—à–µ–Ω–∏–µ:

```sql
-- –ü–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞:
EXPLAIN ANALYZE
SELECT * FROM cars WHERE to_normal(regnum) = 'K123XM';


DROP INDEX IF EXISTS unique_normalized_regnum;
```

> –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `UNIQUE INDEX ON to_normal(regnum)` –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `EXPLAIN` –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.



