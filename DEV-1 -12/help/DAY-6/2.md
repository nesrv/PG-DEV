# –ü—Ä–∞–∫—Ç–∏–∫–∞

## –ü—Ä–æ—Ü–µ–¥—É—Ä—ã SQL (8)


---

## üß™ –ò—Å—Ö–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:

```sql
CREATE TABLE cars (
    id SERIAL PRIMARY KEY,
    regnum TEXT NOT NULL,
    regnum_norm TEXT NOT NULL,
    owner TEXT,
    created_at TIMESTAMP DEFAULT current_timestamp
);
```


## ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 2: –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏

> –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±—ã regnum owner –∏ created_at

### üîß –†–µ—à–µ–Ω–∏–µ:

```sql
ALTER TABLE cars
ADD COLUMN owner TEXT,
ADD COLUMN created_at TIMESTAMP DEFAULT current_timestamp;

```


## ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 3: –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏

**üìå –¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –≤—Å—Ç–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å –Ω–æ–º–µ—Ä–æ–º –∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º.

### üîß –†–µ—à–µ–Ω–∏–µ:

```sql
CREATE OR REPLACE PROCEDURE add_car(p_regnum TEXT, p_owner TEXT)
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO cars(regnum, owner)
    VALUES (p_regnum, p_owner);
END;
$$;
```

üìû –í—ã–∑–æ–≤:

```sql
CALL add_car('A123BC', '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤');
```


## ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 4: C–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É –∫–æ—Ç–æ—Ä–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ –Ω–æ–º–µ—Ä–∞ –≤ –±–∞–∑–µ –≤ –ø–æ–ª–µ regnum_norm


```sql
CREATE OR REPLACE PROCEDURE normalize_all_regnums()
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE cars
    SET regnum_norm = upper(translate(regnum, '–ê–í–ï–ö–ú–ù–û–†–°–¢–£–• ', 'ABEKMHOPCTYX'));
END;
$$;

call normalize_all_regnums();
```

–í PostgreSQL –ø—Ä–æ—Ü–µ–¥—É—Ä—ã (PROCEDURE) –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ PL/pgSQL, –∞ –Ω–µ –Ω–∞ ¬´–æ–±—ã—á–Ω–æ–º SQL¬ª (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –Ω–∞ LANGUAGE SQL).

–ï—Å–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑ —Å –æ–±—ã—á–Ω—ã–º SQL-–∑–∞–ø—Ä–æ—Å–æ–º, —Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–π:

```sql
UPDATE cars
SET regnum_norm = upper(translate(regnum, '–ê–í–ï–ö–ú–ù–û–†–°–¢–£–• ', 'ABEKMHOPCTYX'));
```


## ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 5: –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π

**üìå –¶–µ–ª—å:** –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏, –≥–¥–µ `created_at` —Å—Ç–∞—Ä—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π.

### üîß –†–µ—à–µ–Ω–∏–µ:

```sql
CREATE OR REPLACE PROCEDURE delete_old_cars(p_days INT)
LANGUAGE plpgsql
AS $$
BEGIN
    DELETE FROM cars
    WHERE created_at < NOW() - INTERVAL '1 day' * p_days;
END;
$$;
```

üìû –í—ã–∑–æ–≤:

```sql
CALL delete_old_cars(30);
CALL delete_old_cars(1);
```


```sql
INSERT INTO cars (regnum, regnum_norm, owner)
VALUES
  ('–ê123–í–°', '–ê123–í–°', '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤'),
  ('–í456–ú–ù', '–í456–ú–ù', '–ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤'),
  ('–°789–¢–†', '–°789–¢–†', '–ê–Ω–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞'),
  ('–ö321–£–•', '–ö321–£–•', '–ú–∞—Ä–∏—è –ö—É–∑–Ω–µ—Ü–æ–≤–∞'),
  ('–ï654–û–†', '–ï654–û–†', '–ê–ª–µ–∫—Å–µ–π –°–∏–¥–æ—Ä–æ–≤');

```



## ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 4: –ü–µ—Ä–µ–±–æ—Ä –∏ –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

**üìå –¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–π–¥—ë—Ç—Å—è –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º –∏ –¥–æ–±–∞–≤–∏—Ç –∫ `regnum` –ø—Ä–µ—Ñ–∏–∫—Å `"RUS-"`.

### üîß –†–µ—à–µ–Ω–∏–µ:

```sql
CREATE OR REPLACE PROCEDURE prefix_regnum()
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE cars
    SET regnum = 'RUS-' || regnum
    WHERE regnum NOT LIKE 'RUS-%';
END;
$$;
```

üìû –í—ã–∑–æ–≤:

```sql
CALL prefix_regnum();
```

---

## ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 5: –ü–µ—Ä–µ–¥–∞—á–∞ OUT-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞

**üìå –¶–µ–ª—å:** –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É, –≤–æ–∑–≤—Ä–∞—â–∞—é—â—É—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –±–∞–∑–µ.

### üîß –†–µ—à–µ–Ω–∏–µ:

```sql
CREATE OR REPLACE PROCEDURE count_cars(OUT total BIGINT)
LANGUAGE plpgsql
AS $$
BEGIN
    SELECT COUNT(*) INTO total FROM cars;
END;
$$;
```

üìû –í—ã–∑–æ–≤:

```sql
CALL count_cars(total := NULL);
-- –∑–∞—Ç–µ–º –º–æ–∂–Ω–æ SELECT total; ‚Äî –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å–µ—Å—Å–∏–∏
```

