#!/bin/bash

. ../lib

init

psql_open A 2

start_here 8

###############################################################################
h 'Очистка'

s 1 "CREATE DATABASE $TOPIC_DB;"
s 1 "\c $TOPIC_DB"

c 'Создадим таблицу и запретим для нее автоматическую очистку (чтобы управлять моментом срабатывания).'

s 1 'CREATE TABLE t(
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY
) WITH (autovacuum_enabled = off);'

c 'Вставим в таблицу некоторое количество строк и узнаем размер ее основного слоя:'

s 1 "INSERT INTO t
SELECT n
FROM generate_series(1,1000) as s(n);"

s 1 "SELECT pg_size_pretty(pg_relation_size('t', 'main'));"

c 'Теперь, чтобы еще раз напомнить про понятие горизонта, откроем в другом сеансе транзакцию с активным снимком данных.'

s 2 "\c $TOPIC_DB"
s 2 "BEGIN ISOLATION LEVEL REPEATABLE READ;"
s 2 "SELECT 1; -- любой запрос строит снимок"

c 'Горизонт базы данных определяется этим снимком:'

s 2 "SELECT backend_xmin
FROM pg_stat_activity
WHERE pid = pg_backend_pid();"

horizon=`s_bare 2 "SELECT backend_xmin FROM pg_stat_activity WHERE pid = pg_backend_pid();"`

c 'Обновим все строки таблицы.'

s 1 'UPDATE t SET id = id + 1000;'

c 'Как изменится размер таблицы?'

s 1 "SELECT pg_size_pretty(pg_relation_size('t', 'main'));"

c 'Размер основного слоя таблицы увеличился примерно вдвое.'

c 'Выполним теперь очистку и попросим ее рассказать о том, что происходит:'

s 1 "VACUUM VERBOSE t;"

c 'Обратите внимание: '
ul 'tuples: 0 removed, 2000 remain — ни одна версия строк не может быть очищена,'
ul '1000 are dead but not yet removable — хотя две трети из них — неактуальные,'
ul "removable cutoff: ${horizon} — текущий горизонт,"
ul 'индекс не очищался.'

c 'Завершим параллельную транзакцию...'

s 2 "COMMIT;"

c '...и снова вызовем очистку:'

horizon=`s_bare 2 "SELECT backend_xmin FROM pg_stat_activity WHERE pid = pg_backend_pid();"`
s 1 "VACUUM VERBOSE t;"

c 'Теперь:'
ul "removable cutoff: ${horizon} — горизонт подвинулся,"
ul 'tuples: 1000 removed — очищены все неактуальные версии строк,'
ul 'index scan needed ... 1000 dead item identifiers removed — очищены указатели на них из индекса.'

c 'Посмотрим на размер:'
s 1 "SELECT pg_size_pretty(pg_relation_size('t', 'main'));"

c 'Он не изменился, поскольку все свободное место находится внутри страниц — оно не возвращается операционной системе, но будет использовано для размещения новых версий строк.'

P 13

###############################################################################
h 'Полная очистка'

c 'Вызываем полную очистку таблицы:'

s 1 "VACUUM FULL VERBOSE t;"

c 'Таблица и индекс теперь полностью перестроены. Как изменился размер?'

s 1 "SELECT pg_size_pretty(pg_relation_size('t', 'main'));"


c 'Размер вернулся к первоначальному.'

###############################################################################

stop_here
cleanup
demo_end
