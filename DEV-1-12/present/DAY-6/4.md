# –ü—Ä–∞–∫—Ç–∏–∫–∞

##  `MERGE` 


## üîÑ –ó–∞–¥–∞–Ω–∏–µ: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã `cars` —Å –≤–Ω–µ—à–Ω–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º

### üìã –£—Å–ª–æ–≤–∏–µ:

–£ —Ç–µ–±—è –µ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:

```sql
CREATE TABLE cars (
    id SERIAL PRIMARY KEY,
    regnum TEXT NOT NULL,
    regnum_norm TEXT NOT NULL,
    owner TEXT,
    created_at TIMESTAMP DEFAULT current_timestamp
);
```

–ò –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `cars_external`, –∫—É–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç **–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∏–ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ** –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞:

```sql
CREATE TABLE cars_external (
    regnum TEXT NOT NULL,
    owner TEXT NOT NULL
);

-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
INSERT INTO cars_external (regnum, owner) VALUES
  ('–ê123–í–°', '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤'),   
  ('–í456–ú–ù', '–°–∏–¥–æ—Ä–æ–≤–∞ –ê–Ω–Ω–∞');   

```

---

### üéØ –ó–∞–¥–∞—á–∞:

–° –ø–æ–º–æ—â—å—é **`MERGE`**, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å `cars` —Å `cars_external` –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∞–≤–∏–ª–∞–º:

* –ï—Å–ª–∏ `regnum` —É–∂–µ –µ—Å—Ç—å –≤ `cars` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å `owner` –∏ `regnum_norm`;
* –ï—Å–ª–∏ `regnum` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ `cars` ‚Üí –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º `regnum_norm`.

---

### ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π SQL:

```sql
MERGE INTO cars AS c
USING cars_external AS e
ON c.regnum = e.regnum

WHEN MATCHED THEN
  ...

WHEN NOT MATCHED THEN
 ...
```

> –§—É–Ω–∫—Ü–∏—è `to_normal()` —É–∂–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ 
---

### üß™ –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏:

```sql
-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
INSERT INTO cars_external (regnum, owner) VALUES
  ('–ê123–í–°', '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤'),   -- –æ–±–Ω–æ–≤–∏—Ç
  ('–í456–ú–ù', '–°–∏–¥–æ—Ä–æ–≤–∞ –ê–Ω–Ω–∞');    -- –≤—Å—Ç–∞–≤–∏—Ç

-- –í—ã–ø–æ–ª–Ω–∏—Ç—å MERGE
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```

## –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É –∏–∑ –∑–∞–ø—Ä–æ—Å–∞

```sql
CREATE OR REPLACE PROCEDURE sync_cars()
LANGUAGE plpgsql
AS $$
...
$$;



CREATE OR REPLACE PROCEDURE sync_cars()
LANGUAGE sql
AS $$
   ...

```