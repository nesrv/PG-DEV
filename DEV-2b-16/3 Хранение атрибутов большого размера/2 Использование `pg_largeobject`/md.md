# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `pg_largeobject`.


–í PostgreSQL `pg_largeobject` ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è **–±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤** (large objects, –∏–ª–∏ LOBs), —Ç–∞–∫–∏—Ö –∫–∞–∫ –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ –∏ —Ç.–ø. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–∞–º–∏, –ø—Ä–µ–≤—ã—à–∞—é—â–∏–º–∏ –ª–∏–º–∏—Ç—ã –æ–±—ã—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `bytea`).

---

## üìÅ –ß—Ç–æ —Ç–∞–∫–æ–µ `pg_largeobject`?

`pg_largeobject` ‚Äî —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ö–µ–º–µ `pg_catalog`, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –≤–∏–¥–µ **—Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ 2 –ö–ë**. –¢–æ –µ—Å—Ç—å –∫–∞–∂–¥—ã–π –±–æ–ª—å—à–æ–π –æ–±—ä–µ–∫—Ç —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ.

---

## üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `pg_largeobject`

```sql
\d pg_largeobject
```

–ü–æ–∫–∞–∂–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–ª–µ–¥—É—é—â–µ–µ:

| –ü–æ–ª–µ     | –¢–∏–ø     | –û–ø–∏—Å–∞–Ω–∏–µ                         |
| -------- | ------- | -------------------------------- |
| `loid`   | `oid`   | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–æ–ª—å—à–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞   |
| `pageno` | `int4`  | –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞—á–∏–Ω–∞—è —Å 0)     |
| `data`   | `bytea` | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–º–∞–∫—Å. 2 –ö–ë) |

---

## üß∞ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å `pg_largeobject` –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–æ–º–∞–Ω–¥—ã:

### üîπ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞:

```sql
SELECT lo_create(12345);  -- –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å OID –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º
```

### üîπ –ó–∞–ø–∏—Å—å –≤ –æ–±—ä–µ–∫—Ç:

```sql
SELECT lowrite(lo_open(12345, 131072), 'Some binary data...');
```

`131072` ‚Äî —ç—Ç–æ —Ñ–ª–∞–≥ `INV_WRITE`.

### üîπ –ß—Ç–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞:

```sql
SELECT loread(lo_open(12345, 262144), 2048);
```

`262144` ‚Äî —ç—Ç–æ —Ñ–ª–∞–≥ `INV_READ`.

### üîπ –£–¥–∞–ª–µ–Ω–∏–µ:

```sql
SELECT lo_unlink(12345);
```

---

## ‚öô –ü—Ä–∏–º–µ—Ä—ã –≤ SQL –∏ psql

```sql
-- –í—Å—Ç–∞–≤–∏—Ç—å —Ñ–∞–π–ª:
\lo_import '/path/to/file' 12345

-- –ò–∑–≤–ª–µ—á—å —Ñ–∞–π–ª:
\lo_export 12345 '/path/to/save/file'
```

---

## üí° –û—Ç–ª–∏—á–∏—è –æ—Ç TOAST

* `pg_largeobject` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–≤—Ä—É—á–Ω—É—é** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ–ª—å—à–∏–º–∏ –±–∏–Ω–∞—Ä–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
* TOAST (The Oversized-Attribute Storage Technique) —Ä–∞–±–æ—Ç–∞–µ—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —Å –±–æ–ª—å—à–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö (`text`, `bytea`, `jsonb` –∏ –¥—Ä.).

---

## ‚úÖ –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

* –ù—É–∂–Ω–æ **–ø–æ—ç—Ç–∞–ø–Ω–æ–µ** —á—Ç–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞).
* –û–±—ä–µ–∫—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å **–±–æ–ª—å—à–∏–º–∏ –ø–æ —Ä–∞–∑–º–µ—Ä—É** (—Å–æ—Ç–Ω–∏ –ú–ë –∏–ª–∏ –ì–ë).
* –¢—Ä–µ–±—É–µ—Ç—Å—è **–≤–Ω–µ—à–Ω—è—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç).

---

–í–æ—Ç –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è **–±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (`pg_largeobject`) –≤ PL/pgSQL**: –º—ã —Å–æ–∑–¥–∞–¥–∏–º –±–æ–ª—å—à–æ–π –æ–±—ä–µ–∫—Ç, –∑–∞–ø–∏—à–µ–º –≤ –Ω–µ–≥–æ –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–æ—á–∏—Ç–∞–µ–º –∏—Ö –æ–±—Ä–∞—Ç–Ω–æ.

---

## üß™ –ü—Ä–∏–º–µ—Ä: –∑–∞–ø–∏—Å—å –∏ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ `pg_largeobject` –Ω–∞ PL/pgSQL

```sql
DO $$
DECLARE
    lobj_oid OID;
    fd INT;
    data TEXT := '–ü—Ä–∏–º–µ—Ä –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ pg_largeobject';
    buffer BYTEA;
BEGIN
    -- –°–æ–∑–¥–∞–µ–º –±–æ–ª—å—à–æ–π –æ–±—ä–µ–∫—Ç (–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è OID ‚Äî –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    lobj_oid := lo_create(0);
    RAISE NOTICE '–°–æ–∑–¥–∞–Ω –±–æ–ª—å—à–æ–π –æ–±—ä–µ–∫—Ç —Å OID: %', lobj_oid;

    -- –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ (—Ñ–ª–∞–≥ 131072 = INV_WRITE)
    fd := lo_open(lobj_oid, 131072);
    PERFORM lowrite(fd, convert_to(data, 'UTF8'));
    PERFORM lo_close(fd);

    -- –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è (—Ñ–ª–∞–≥ 262144 = INV_READ)
    fd := lo_open(lobj_oid, 262144);
    buffer := loread(fd, 2048);  -- —á–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ 2 –ö–ë
    PERFORM lo_close(fd);

    RAISE NOTICE '–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: %', convert_from(buffer, 'UTF8');
    
    -- –ù–µ –∑–∞–±—É–¥—å —É–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
    -- PERFORM lo_unlink(lobj_oid);

END $$;
```

---

## üîç –ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

* `lo_create(0)` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –±–æ–ª—å—à–æ–π –æ–±—ä–µ–∫—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ `OID`.
* `lo_open(...)` ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å –Ω—É–∂–Ω—ã–º —Ñ–ª–∞–≥–æ–º (`INV_WRITE`, `INV_READ`).
* `lowrite(...)` ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ.
* `loread(...)` ‚Äî —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ.
* `convert_to` –∏ `convert_from` ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç –º–µ–∂–¥—É `TEXT` –∏ `BYTEA`.

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

* –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è **–≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**.
* –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ (`lo_create`, `lo_open`, –∏ —Ç.–ø.) —è–≤–ª—è—é—Ç—Å—è –æ–±—ë—Ä—Ç–∫–∞–º–∏ –Ω–∞–¥ C API –∏ —Ç—Ä–µ–±—É—é—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.

---
